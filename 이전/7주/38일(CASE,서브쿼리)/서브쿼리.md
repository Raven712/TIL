# 서브쿼리

- 특정값을 메인쿼리에 반환하여 활용하는것.
- 실제테이블에 없는 기준을 이용한 검색이 가능함.
- 서브쿼리는 소괄호로 감싸서 사용, 메인쿼리의 칼럼을 모두 사용가능함!
- 메인쿼리는 서브쿼리의 칼럼을 사용할 수 없음.

```sqlite
SELECT *
FROM 테이블이름
WHERE 칼럼1 = (
	SELECT 칼럼1
	FROM 테이블이름
),
```

- 단일행 서브쿼리
- 다중행 서브쿼리
- 다중컬럼 서브쿼리 로 나뉨.



### 단일 행 서브쿼리

- 서브쿼리 결과가 0또는 1개인 경우
- 단일 행 비교 연산자와 함께 사용 (=, <, <= ,> ... != 같은것)

```sqlite
USERS에서 나이가 제일 작은 사람의 수는?
내 생각
SELECT COUNT(age) FROM users WHERE age = MIN(age);
--->WHERE age = MIN(age) 에서 에러가 남.

답
--->
SELECT age, COUNT(*) FROM users GROUP BY age ORDER BY age LIMIT 1; <이렇게 해야 나옴.


그런데 서브쿼리로 표현하면?
--->
SELECT MIN(age)
FROM users;
-- 최소나이 출력됨.

SELECT COUNT(*) FROM users WHERE age = 최소나이;

---> 서브쿼리는?
SELECT COUNT(*) FROM users WHERE age = (SELECT MIN(age) FROM users);

--> 서브쿼리는 (SELECT MIN(age) FROM users)
---> 메인쿼리는 SELECT COUNT(*) FROM users WHERE age = (SELECT MIN(age) FROM users);

```



```sqlite
그럼, users에서 평균 계좌 잔고보다 잔고가 높은사람의 수는?
SELECT AVG(balance) FROM users; <<< 서브쿼리.

SELECT COUNT(*) FROM users WHERE balance > (SELECT AVG(balance) FROM users);
-----
users 에서 유은정과 같은 지역에 사는 사람의 수는? <<<< 어케하지
SELECT location, last_name, first_name FROM users WHERE last_name = '유' AND first_name = '은정';

SELECT COUNT(*) FROM users WHERE country = (SELECT location, last_name, first_name FROM users WHERE last_name = '유' AND first_name = '은정';) 이렇게해야함.

---
전체 인원과 평균연봉, 평균 나이를 출력하기.
SELECT COUNT(*), AVG(age), AVG(balance) FROM users; 하면 안되나? --> O. 그러나 이름변경은?

SELECT (SELECT COUNT(*) FROM users) AS 전체인원,
		(SELECT AVG(balance) FROM users) AS 평균연봉; --  .. 이렇게해야됨

서브쿼리로 한다면?

SELECT XXX UPDATE O

UPDATE users SET balance = (SELECT AVG(balance) FROM users); 
```
